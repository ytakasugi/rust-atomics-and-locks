# 第7章 プロセッサーを理解する

第2章と第3章の理論は、正しい並行コードを書くために必要なものですが、さらに、プロセッサレベルで実際に何が行われているのかをおおよそ理解することも非常に有効です。本章では、アトミック演算をコンパイルするマシン命令、プロセッサ・アーキテクチャの違い、弱いバージョンの`compare_exchange`が存在する理由、個々の命令の最下層におけるメモリ順序の意味、そしてキャッシングがこれらとどう関係しているのかを探ります。

この章の目的は、すべてのプロセッサ・アーキテクチャの関連する詳細をすべて理解することではありません。そのためには、本棚いっぱいの本が必要で、その多くはおそらく未執筆か公開されていないでしょう。その代わり、本章の目標は、アトミックがプロセッサレベルでどのように機能するかについての一般的な考え方を身につけ、アトミックを含むコードを実装し最適化する際に、より多くの情報に基づいた意思決定を行えるようにすることです。そしてもちろん、舞台裏で何が起こっているのかという好奇心を満たすため、抽象的な理論から一旦離れることでもあります。

ここでは、できるだけ具体的に説明するために、2つのプロセッサ・アーキテクチャに焦点を当てます：

x86-64:
x86-64：ノートパソコン、デスクトップパソコン、サーバー、ゲーム機などの大半で使用されているIntelとAMDのプロセッサが実装するx86アーキテクチャの64ビット版です。元々16ビットのx86アーキテクチャとその非常に人気のある32ビット拡張はインテルによって開発されましたが、現在x86-64と呼ばれている64ビット版は、当初AMDによって開発された拡張で、しばしばAMD64と呼ばれています。インテルも独自の64ビットアーキテクチャであるIA-64を開発したが、結局はAMDのより人気のあるx86拡張機能を採用した（IA-32e、EM64T、後にIntel 64という名称になる）。

ARM64：
ARMアーキテクチャの64ビット版で、ほぼすべての最新モバイル機器、高性能組み込みシステム、そして最近のノートパソコンやデスクトップパソコンで使用されるようになってきています。AArch64とも呼ばれ、ARMv8の一部として導入された。ARMの初期バージョン（32ビット）は、多くの点で類似していますが、さらに幅広いアプリケーションで使用されています。自動車から電子COVID検査まで、想像できるあらゆる種類の組み込みシステムで人気のあるマイクロコントローラの多くは、ARMv6とARMv7をベースにしています。

この2つのアーキテクチャは、多くの点で似て非なるものです。最も重要なのは、アトミックに対するアプローチが異なることです。この2つのアーキテクチャでアトミックがどのように動作するかを理解することで、他の多くのアーキテクチャに適用できる、より一般的な理解を得ることができます。
